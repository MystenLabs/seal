"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[325],{5472(e,r,n){n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>g});const t=JSON.parse('{"id":"Aggregator","title":"Aggregator Server","description":"Learn how the Aggregator Server acts as a gateway between clients and Seal MPC committee member key servers, aggregating encrypted partial key shares.","source":"@site/../content/Aggregator.mdx","sourceDirName":".","slug":"/Aggregator","permalink":"/Aggregator","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Aggregator Server","description":"Learn how the Aggregator Server acts as a gateway between clients and Seal MPC committee member key servers, aggregating encrypted partial key shares.","keywords":["aggregator server","Seal MPC","key server","committee members","encrypted signatures","DKG","API credentials","Lagrange interpolation"]},"sidebar":"docsSidebar","previous":{"title":"Key Server Operations for Committee Server Type","permalink":"/KeyServerCommitteeOps"},"next":{"title":"Seal CLI","permalink":"/SealCLI"}}');var s=n(2615),i=n(7545),a=n(7555);const o={title:"Aggregator Server",description:"Learn how the Aggregator Server acts as a gateway between clients and Seal MPC committee member key servers, aggregating encrypted partial key shares.",keywords:["aggregator server","Seal MPC","key server","committee members","encrypted signatures","DKG","API credentials","Lagrange interpolation"]},c="Aggregator Server",l={},g=[{value:"Overview",id:"overview",level:2},{value:"Setup",id:"setup",level:2},{value:"Initial setup (fresh DKG)",id:"initial-setup-fresh-dkg",level:3},{value:"Key rotation",id:"key-rotation",level:3},{value:"Running the server",id:"running-the-server",level:2},{value:"Running with Docker",id:"running-with-docker",level:3},{value:"Infrastructure requirements",id:"infrastructure-requirements",level:2},...a.RM];function h(e){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"aggregator-server",children:"Aggregator Server"})}),"\n",(0,s.jsx)(r.p,{children:"The Aggregator Server supports Seal MPC committees by acting as a gateway between clients and committee member key servers. It fetches encrypted partial key shares from committee members, verifies their encrypted signatures, aggregates the shares into a single encrypted key, and returns the result to the client. The aggregator authenticates to member key servers using private API keys."}),"\n",(0,s.jsx)(r.p,{children:"Because the aggregator never holds or stores cryptographic key material, it is trustless \u2014 anyone can run one. The aggregator's correctness can be verified independently: all partial shares are cryptographically signed by their respective committee members, so a misbehaving aggregator cannot produce a valid response without honest member participation."}),"\n",(0,s.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(r.p,{children:"The aggregator server performs the following tasks:"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsx)(r.li,{children:"Loads the committee's configuration from the network, including the threshold, member URLs, and partial public keys."}),"\n",(0,s.jsx)(r.li,{children:"Receives fetch key requests from clients."}),"\n",(0,s.jsx)(r.li,{children:"Fans out each request to committee member servers until it collects responses from enough members to satisfy the threshold."}),"\n",(0,s.jsx)(r.li,{children:"Verifies each encrypted signature using the corresponding partial public key."}),"\n",(0,s.jsx)(r.li,{children:"Aggregates the encrypted partial responses using Lagrange interpolation."}),"\n",(0,s.jsx)(r.li,{children:"Returns the aggregated encrypted key to the client."}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"setup",children:"Setup"}),"\n",(0,s.jsx)(r.p,{children:"The aggregator authenticates with each committee member's key server using private API keys."}),"\n",(0,s.jsx)(r.h3,{id:"initial-setup-fresh-dkg",children:"Initial setup (fresh DKG)"}),"\n",(0,s.jsx)(r.p,{children:"After a fresh DKG completes, the coordinator shares the following information with the aggregator operator:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Key server object ID"})," (",(0,s.jsx)(r.code,{children:"KEY_SERVER_OBJ_ID"}),"): The object ID created when the committee is finalized on-chain."]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"API credentials for all committee members"}),", including:","\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"The on-chain server name"}),"\n",(0,s.jsx)(r.li,{children:"The API key name"}),"\n",(0,s.jsx)(r.li,{children:"The API key"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:["The aggregator operator configures these values in ",(0,s.jsx)(r.code,{children:"aggregator-config.yaml"})," and then deploys the aggregator server."]}),"\n",(0,s.jsx)(r.h3,{id:"key-rotation",children:"Key rotation"}),"\n",(0,s.jsxs)(r.p,{children:["If new members join the committee during key rotation, the coordinator shares their API credentials with the aggregator operator. The aggregator operator adds the new credentials to ",(0,s.jsx)(r.code,{children:"aggregator-config.yaml"})," and restarts the server."]}),"\n",(0,s.jsx)(r.p,{children:"The aggregator configuration can include credentials for both old and new member names. The aggregator periodically reads the current committee state from the network and uses the latest on-chain member list to determine which credentials to use."}),"\n",(0,s.jsx)(r.h2,{id:"running-the-server",children:"Running the server"}),"\n",(0,s.jsxs)(r.p,{children:["Edit ",(0,s.jsx)(r.code,{children:"aggregator-config.yaml"})," to match your environment. Set the target network, the key server object ID provided by the coordinator, and the API credentials for all committee members:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"# The network for the object.\nnetwork: !Testnet\n# The committee server object ID.\nkey_server_object_id: '0x0000000000000000000000000000000000000000000000000000000000000000'\n\n# API credentials for committee members.\napi_credentials:\n    server1: # on-chain server name\n      api_key_name: keyname1\n      api_key: key1\n    server2:\n      api_key_name: keyname2\n      api_key: key2\n"})}),"\n",(0,s.jsx)(r.p,{children:"Then run:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell",children:"CONFIG_PATH=crates/key-server/src/aggregator/aggregator-config.yaml cargo run --bin aggregator-server\n"})}),"\n",(0,s.jsx)(r.h3,{id:"running-with-docker",children:"Running with Docker"}),"\n",(0,s.jsx)(r.p,{children:"Build the image:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell",children:"docker build -f Dockerfile.aggregator -t aggregator-server:latest .\n"})}),"\n",(0,s.jsx)(r.p,{children:"Run the server:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-shell",children:"docker run -p 2024:2024 \\\n  -v $(pwd)/crates/key-server/src/aggregator/aggregator-config.yaml:/config/aggregator-config.yaml \\\n  -e CONFIG_PATH=/config/aggregator-config.yaml \\\n  aggregator-server\n"})}),"\n",(0,s.jsx)(r.h2,{id:"infrastructure-requirements",children:"Infrastructure requirements"}),"\n",(0,s.jsx)(a.Ay,{})]})}function d(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},7555(e,r,n){n.d(r,{Ay:()=>o,RM:()=>i});var t=n(2615),s=n(7545);const i=[{value:"CORS configuration",id:"cors-configuration",level:3}];function a(e){const r={a:"a",code:"code",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.p,{children:["The server is a lightweight, stateless service designed for easy horizontal scaling. Because it doesn't require persistent storage, you can run multiple instances behind a load balancer to increase availability and resilience. Each instance must have access to a trusted ",(0,t.jsx)(r.a,{href:"https://docs.sui.io/guides/operator/sui-full-node",children:"Sui full node"})," \u2014 ideally one that's geographically close to reduce latency during policy checks and key operations."]}),"\n",(0,t.jsx)(r.p,{children:"To operate the server securely, it is recommended to place it behind an API gateway or reverse proxy. This allows you to:"}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"Expose the service over HTTPS and terminate SSL/TLS at the edge"}),"\n",(0,t.jsx)(r.li,{children:"Enforce rate limiting and prevent abuse"}),"\n",(0,t.jsx)(r.li,{children:"Authenticate requests using API keys or access tokens"}),"\n",(0,t.jsx)(r.li,{children:"Optionally integrate usage tracking for commercial or billable offerings, such as logging access frequency per client or package"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:["For observability, the server exposes Prometheus-compatible metrics on port ",(0,t.jsx)(r.code,{children:"9184"}),". You can access raw metrics by running ",(0,t.jsx)(r.code,{children:"curl http://0.0.0.0:9184"}),". These metrics can also be visualized using tools like Grafana. The key server also includes a basic health check endpoint on port ",(0,t.jsx)(r.code,{children:"2024"}),": ",(0,t.jsx)(r.code,{children:"curl http://0.0.0.0:2024/health"}),"."]}),"\n",(0,t.jsx)(r.h3,{id:"cors-configuration",children:"CORS configuration"}),"\n",(0,t.jsx)(r.p,{children:"Configure Cross-Origin Resource Sharing (CORS) on your server to allow applications to make requests directly from the browser. Use the following recommended headers:"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-shell",children:"Access-Control-Allow-Origin: *\nAccess-Control-Allow-Methods: GET, POST, OPTIONS\nAccess-Control-Allow-Headers: Request-Id, Client-Sdk-Type, Client-Sdk-Version\nAccess-Control-Expose-Headers: x-keyserver-version\n"})}),"\n",(0,t.jsxs)(r.p,{children:["If your server requires an API key, make sure to include the corresponding HTTP header name in ",(0,t.jsx)(r.code,{children:"Access-Control-Allow-Headers"})," as well."]})]})}function o(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},7545(e,r,n){n.d(r,{R:()=>a,x:()=>o});var t=n(9471);const s={},i=t.createContext(s);function a(e){const r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:r},e.children)}}}]);